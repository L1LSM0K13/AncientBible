# DOM Selector

[![build](https://github.com/asamuzaK/domSelector/actions/workflows/node.js.yml/badge.svg)](https://github.com/asamuzaK/domSelector/actions/workflows/node.js.yml)
[![CodeQL](https://github.com/asamuzaK/domSelector/actions/workflows/codeql.yml/badge.svg)](https://github.com/asamuzaK/domSelector/actions/workflows/codeql.yml)
[![npm (scoped)](https://img.shields.io/npm/v/@asamuzakjp/dom-selector)](https://www.npmjs.com/package/@asamuzakjp/dom-selector)

A CSS selector engine.

## Install

```console
npm i @asamuzakjp/dom-selector
```

## Usage

```javascript
import {
  matches, closest, querySelector, querySelectorAll
} from '@asamuzakjp/dom-selector';
```

<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

### matches(selector, node, opt)

matches - same functionality as [Element.matches()][64]

#### Parameters

- `selector` **[string][59]** CSS selector
- `node` **[object][60]** Element node
- `opt` **[object][60]?** options
  - `opt.warn` **[boolean][61]?** console warn e.g. unsupported pseudo-class

Returns **[boolean][61]** `true` if matched, `false` otherwise


### closest(selector, node, opt)

closest - same functionality as [Element.closest()][65]

#### Parameters

- `selector` **[string][59]** CSS selector
- `node` **[object][60]** Element node
- `opt` **[object][60]?** options
  - `opt.warn` **[boolean][61]?** console warn e.g. unsupported pseudo-class

Returns **[object][60]?** matched node


### querySelector(selector, node, opt)

querySelector - same functionality as [Document.querySelector()][66], [DocumentFragment.querySelector()][67], [Element.querySelector()][68]

#### Parameters

- `selector` **[string][59]** CSS selector
- `node` **[object][60]** Document, DocumentFragment or Element node
- `opt` **[object][60]?** options
  - `opt.warn` **[boolean][61]?** console warn e.g. unsupported pseudo-class

Returns **[object][60]?** matched node


### querySelectorAll(selector, node, opt)

querySelectorAll - same functionality as [Document.querySelectorAll()][69], [DocumentFragment.querySelectorAll()][70], [Element.querySelectorAll()][71]  
**NOTE**: returns Array, not NodeList

#### Parameters

- `selector` **[string][59]** CSS selector
- `node` **[object][60]** Document, DocumentFragment or Element node
- `opt` **[object][60]?** options
  - `opt.warn` **[boolean][61]?** console warn e.g. unsupported pseudo-class

Returns **[Array][62]&lt;([object][60] \| [undefined][63])>** array of matched nodes


## Supported CSS selectors

|Pattern|Supported|Note|
|:--------|:-------:|:--------|
|\*|✓| |
|ns\|E|✓| |
|\*\|E|✓| |
|\|E|✓| |
|E|✓| |
|E:not(s1, s2, …)|✓| |
|E:is(s1, s2, …)|✓| |
|E:where(s1, s2, …)|✓| |
|E:has(rs1, rs2, …)|✓| |
|E.warning|✓| |
|E#myid|✓| |
|E\[foo\]|✓| |
|E\[foo="bar"\]|✓| |
|E\[foo="bar"&nbsp;i\]|✓| |
|E\[foo="bar"&nbsp;s\]|✓| |
|E\[foo~="bar"\]|✓| |
|E\[foo^="bar"\]|✓| |
|E\[foo$="bar"\]|✓| |
|E\[foo*="bar"\]|✓| |
|E\[foo\|="en"\]|✓| |
|E:defined|Unsupported| |
|E:dir(ltr)|✓| |
|E:lang(en)|Partially supported|Comma-separated list of language codes, e.g. `:lang(en, fr)`, is not yet supported.|
|E:any&#8209;link|✓| |
|E:link|✓| |
|E:visited|✓|Returns `false` or `null` to prevent fingerprinting.|
|E:local&#8209;link|✓| |
|E:target|✓| |
|E:target&#8209;within|✓| |
|E:scope|✓| |
|E:current|Unsupported| |
|E:current(s)|Unsupported| |
|E:past|Unsupported| |
|E:future|Unsupported| |
|E:active|Unsupported| |
|E:hover|Unsupported| |
|E:focus|✓| |
|E:focus&#8209;within|✓| |
|E:focus&#8209;visible|Unsupported| |
|E:enabled<br>E:disabled|✓| |
|E:read&#8209;write<br>E:read&#8209;only|✓| |
|E:placeholder&#8209;shown|✓| |
|E:default|✓| |
|E:checked|✓| |
|E:indeterminate|✓| |
|E:valid<br>E:invalid|✓| |
|E:required<br>E:optional|✓| |
|E:blank|Unsupported| |
|E:user&#8209;invalid|Unsupported| |
|E:root|✓| |
|E:empty|✓| |
|E:nth&#8209;child(n&nbsp;[of&nbsp;S]?)|✓| |
|E:nth&#8209;last&#8209;child(n&nbsp;[of&nbsp;S]?)|✓| |
|E:first&#8209;child|✓| |
|E:last&#8209;child|✓| |
|E:only&#8209;child|✓| |
|E:nth&#8209;of&#8209;type(n)|✓| |
|E:nth&#8209;last&#8209;of&#8209;type(n)|✓| |
|E:first&#8209;of&#8209;type|✓| |
|E:last&#8209;of&#8209;type|✓| |
|E:only&#8209;of&#8209;type|✓| |
|E&nbsp;F|✓| |
|E > F|✓| |
|E + F|✓| |
|E ~ F|✓| |
|F \|\| E|Unsupported| |
|E:nth&#8209;col(n)|Unsupported| |
|E:nth&#8209;last&#8209;col(n)|Unsupported| |
|:host|✓| |
|:host(s)|✓| |
|:host&#8209;context(s)|✓| |


## Monkey patch jsdom

``` javascript
import { JSDOM } from 'jsdom';
import {
  closest, matches, querySelector, querySelectorAll
} from '@asamuzakjp/dom-selector';

const dom = new JSDOM('', {
  runScripts: 'dangerously',
  url: 'http://localhost/',
  beforeParse: window => {
    window.Element.prototype.matches = function (...args) {
      if (!args.length) {
        throw new window.TypeError('1 argument required, but only 0 present.');
      }
      const [selector] = args;
      return matches(selector, this);
    };
    window.Element.prototype.closest = function (...args) {
      if (!args.length) {
        throw new window.TypeError('1 argument required, but only 0 present.');
      }
      const [selector] = args;
      return closest(selector, this);
    };
    window.Document.prototype.querySelector = function (...args) {
      if (!args.length) {
        throw new window.TypeError('1 argument required, but only 0 present.');
      }
      const [selector] = args;
      return querySelector(selector, this);
    };
    window.DocumentFragment.prototype.querySelector = function (...args) {
      if (!args.length) {
        throw new window.TypeError('1 argument required, but only 0 present.');
      }
      const [selector] = args;
      return querySelector(selector, this);
    };
    window.Element.prototype.querySelector = function (...args) {
      if (!args.length) {
        throw new window.TypeError('1 argument required, but only 0 present.');
      }
      const [selector] = args;
      return querySelector(selector, this);
    };
    window.Document.prototype.querySelectorAll = function (...args) {
      if (!args.length) {
        throw new window.TypeError('1 argument required, but only 0 present.');
      }
      const [selector] = args;
      return querySelectorAll(selector, this);
    };
    window.DocumentFragment.prototype.querySelectorAll = function (...args) {
      if (!args.length) {
        throw new window.TypeError('1 argument required, but only 0 present.');
      }
      const [selector] = args;
      return querySelectorAll(selector, this);
    };
    window.Element.prototype.querySelectorAll = function (...args) {
      if (!args.length) {
        throw new window.TypeError('1 argument required, but only 0 present.');
      }
      const [selector] = args;
      return querySelectorAll(selector, this);
    };
  }
});
```

### Performance

|method('selector')|jsdom v23.1.0 (nwsapi)|patched-jsdom (dom-selector)|Result|
|:-----------------|:-----------------|:-----------------|:-----------------|
|matches('.content')|2,619,610 ops/sec ±0.65%|125,248 ops/sec ±0.23%|jsdom is 20.9 times faster than patched-jsdom. patched-jsdom took 0.008msec.|
|matches('div.container:not(.box)')|1,373,626 ops/sec ±0.82%|73,757 ops/sec ±0.39%|jsdom is 18.6 times faster than patched-jsdom. patched-jsdom took 0.014msec.|
|matches('.box + .box')|2,268,829 ops/sec ±0.29%|104,000 ops/sec ±0.25%|jsdom is 21.8 times faster than patched-jsdom. patched-jsdom took 0.010msec.|
|matches('.box ~ .box')|2,197,324 ops/sec ±1.96%|104,061 ops/sec ±1.71%|jsdom is 21.1 times faster than patched-jsdom. patched-jsdom took 0.010msec.|
|matches('.box > .block')|2,317,373 ops/sec ±1.73%|104,357 ops/sec ±1.55%|jsdom is 22.2 times faster than patched-jsdom. patched-jsdom took 0.010msec.|
|matches('.box .content')|372,390 ops/sec ±1.11%|59,051 ops/sec ±1.57%|jsdom is 6.3 times faster than patched-jsdom. patched-jsdom took 0.017msec.|
|matches('.box:first-child ~ .box:nth-of-type(4n+1) + .box .block.inner > .content')|179,843 ops/sec ±1.33%|18,116 ops/sec ±2.72%|jsdom is 9.9 times faster than patched-jsdom. patched-jsdom took 0.055msec.|
|matches('.box:first-child ~ .box:nth-of-type(4n+1) + .box .block.inner:has(>.content)')|N/A|39,736 ops/sec ±0.60%|jsdom failed. patched-jsdom took 0.025msec.|
|closest('.content')|1,741,518 ops/sec ±1.78%|70,161 ops/sec ±1.50%|jsdom is 24.8 times faster than patched-jsdom. patched-jsdom took 0.014msec.|
|closest('div.container:not(.box)')|272,910 ops/sec ±1.50%|34,077 ops/sec ±2.60%|jsdom is 8.0 times faster than patched-jsdom. patched-jsdom took 0.029msec.|
|closest('.box + .box')|435,648 ops/sec ±1.41%|54,061 ops/sec ±1.55%|jsdom is 8.1 times faster than patched-jsdom. patched-jsdom took 0.018msec.|
|closest('.box ~ .box')|186,494 ops/sec ±1.66%|34,801 ops/sec ±1.47%|jsdom is 5.4 times faster than patched-jsdom. patched-jsdom took 0.029msec.|
|closest('.box > .block')|472,464 ops/sec ±1.55%|51,083 ops/sec ±1.44%|jsdom is 9.2 times faster than patched-jsdom. patched-jsdom took 0.020msec.|
|closest('.box .content')|356,393 ops/sec ±1.48%|42,369 ops/sec ±1.56%|jsdom is 8.4 times faster than patched-jsdom. patched-jsdom took 0.024msec.|
|closest('.box:first-child ~ .box:nth-of-type(4n+1) + .box .block.inner > .content')|173,085 ops/sec ±1.45%|16,152 ops/sec ±1.51%|jsdom is 10.7 times faster than patched-jsdom. patched-jsdom took 0.062msec.|
|closest('.box:first-child ~ .box:nth-of-type(4n+1) + .box .block.inner:has(>.content)')|N/A|12,085 ops/sec ±3.06%|jsdom failed. patched-jsdom took 0.083msec.|
|querySelector('.content')|3,259 ops/sec ±1.17%|61,736 ops/sec ±1.81%|patched-jsdom is 18.9 times faster than jsdom. patched-jsdom took 0.016msec.|
|querySelector('div.container:not(.box)')|81,006 ops/sec ±1.08%|43,620 ops/sec ±1.80%|jsdom is 1.9 times faster than patched-jsdom. patched-jsdom took 0.023msec.|
|querySelector('.box + .box')|81,994 ops/sec ±1.38%|58,501 ops/sec ±2.06%|jsdom is 1.4 times faster than patched-jsdom. patched-jsdom took 0.017msec.|
|querySelector('.box ~ .box')|84,898 ops/sec ±0.19%|29,419 ops/sec ±1.54%|jsdom is 2.9 times faster than patched-jsdom. patched-jsdom took 0.034msec.|
|querySelector('.box > .block')|1,391 ops/sec ±0.26%|55,995 ops/sec ±1.68%|patched-jsdom is 40.3 times faster than jsdom. patched-jsdom took 0.018msec.|
|querySelector('.box .content')|676 ops/sec ±1.84%|39,209 ops/sec ±1.53%|patched-jsdom is 58.0 times faster than jsdom. patched-jsdom took 0.026msec.|
|querySelector('.box:first-child ~ .box:nth-of-type(4n+1) + .box .block.inner > .content')|243 ops/sec ±2.53%|1,002 ops/sec ±1.38%|patched-jsdom is 4.1 times faster than jsdom. patched-jsdom took 0.998msec.|
|querySelector('.box:first-child ~ .box:nth-of-type(4n+1) + .box .block.inner:has(>.content)')|N/A|795 ops/sec ±1.31%|jsdom failed. patched-jsdom took 1.257msec.|
|querySelectorAll('.content')|3,005 ops/sec ±1.14%|828 ops/sec ±1.20%|jsdom is 3.6 times faster than patched-jsdom. patched-jsdom took 1.207msec.|
|querySelectorAll('div.container:not(.box)')|101,993 ops/sec ±1.37%|23,041 ops/sec ±1.67%|jsdom is 4.4 times faster than patched-jsdom. patched-jsdom took 0.043msec.|
|querySelectorAll('.box + .box')|103,056 ops/sec ±1.41%|29,089 ops/sec ±0.28%|jsdom is 3.5 times faster than patched-jsdom. patched-jsdom took 0.034msec.|
|querySelectorAll('.box ~ .box')|103,236 ops/sec ±1.39%|11,858 ops/sec ±1.79%|jsdom is 8.7 times faster than patched-jsdom. patched-jsdom took 0.084msec.|
|querySelectorAll('.box > .block')|1,375 ops/sec ±1.27%|4,280 ops/sec ±1.63%|patched-jsdom is 3.1 times faster than jsdom. patched-jsdom took 0.234msec.|
|querySelectorAll('.box .content')|669 ops/sec ±1.28%|716 ops/sec ±0.21%|patched-jsdom is 1.1 times faster than jsdom. patched-jsdom took 1.397msec.|
|querySelectorAll('.box:first-child ~ .box:nth-of-type(4n+1) + .box .block.inner > .content')|279 ops/sec ±0.20%|1,005 ops/sec ±1.43%|patched-jsdom is 3.6 times faster than jsdom. patched-jsdom took 0.995msec.|
|querySelectorAll('.box:first-child ~ .box:nth-of-type(4n+1) + .box .block.inner:has(>.content)')|N/A|792 ops/sec ±1.42%|jsdom failed. patched-jsdom took 1.262msec.|


## Acknowledgments

The following resources have been of great help in the development of the DOM Selector.

- [CSSTree](https://github.com/csstree/csstree)
- [selery](https://github.com/danburzo/selery)
- [jsdom](https://github.com/jsdom/jsdom)


---
Copyright (c) 2023 [asamuzaK (Kazz)](https://github.com/asamuzaK/)


[1]: #matches
[2]: #parameters
[3]: #closest
[4]: #parameters-1
[5]: #queryselector
[6]: #parameters-2
[7]: #queryselectorall
[8]: #parameters-3
[59]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String
[60]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object
[61]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean
[62]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array
[63]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/undefined
[64]: https://developer.mozilla.org/docs/Web/API/Element/matches
[65]: https://developer.mozilla.org/docs/Web/API/Element/closest
[66]: https://developer.mozilla.org/docs/Web/API/Document/querySelector
[67]: https://developer.mozilla.org/docs/Web/API/DocumentFragment/querySelector
[68]: https://developer.mozilla.org/docs/Web/API/Element/querySelector
[69]: https://developer.mozilla.org/docs/Web/API/Document/querySelectorAll
[70]: https://developer.mozilla.org/docs/Web/API/DocumentFragment/querySelectorAll
[71]: https://developer.mozilla.org/docs/Web/API/Element/querySelectorAll
